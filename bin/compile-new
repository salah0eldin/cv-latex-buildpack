#!/bin/bash
# Buildpack compile script for minimal LaTeX setup using TinyTeX

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing TinyTeX for CV generation"

# Set up directories
TEXLIVE_DIR="$BUILD_DIR/.texlive"
TEXLIVE_CACHE="$CACHE_DIR/texlive"

# Create directories
mkdir -p "$TEXLIVE_CACHE"
mkdir -p "$TEXLIVE_DIR"

# Use TinyTeX which is designed to be portable and lightweight
TINYTEX_URL="https://github.com/rstudio/tinytex-releases/releases/download/v2023.05/TinyTeX-1-v2023.05.tar.gz"
TINYTEX_ARCHIVE="$TEXLIVE_CACHE/tinytex.tar.gz"

echo "-----> Downloading TinyTeX (lightweight, portable TeX Live)"
if [ ! -f "$TINYTEX_ARCHIVE" ]; then
    curl -L -o "$TINYTEX_ARCHIVE" "$TINYTEX_URL" || {
        echo "ERROR: Failed to download TinyTeX"
        exit 1
    }
fi

echo "-----> Extracting TinyTeX to $TEXLIVE_DIR"
cd "$TEXLIVE_DIR"
tar -xzf "$TINYTEX_ARCHIVE" --strip-components=1 || {
    echo "ERROR: Failed to extract TinyTeX"
    exit 1
}

# Find the correct bin directory
TEXLIVE_BIN_DIR=""
for possible_dir in "$TEXLIVE_DIR/.TinyTeX/bin/x86_64-linux" "$TEXLIVE_DIR/bin/x86_64-linux" "$TEXLIVE_DIR/bin/linux"; do
    if [ -d "$possible_dir" ]; then
        TEXLIVE_BIN_DIR="$possible_dir"
        break
    fi
done

if [ -z "$TEXLIVE_BIN_DIR" ]; then
    echo "ERROR: Could not find TeX Live binaries"
    echo "Available directories:"
    find "$TEXLIVE_DIR" -type d -name "bin" 2>/dev/null || echo "No bin directories found"
    exit 1
fi

echo "-----> Found TeX Live binaries at: $TEXLIVE_BIN_DIR"

# Test if pdflatex exists and works
if [ ! -x "$TEXLIVE_BIN_DIR/pdflatex" ]; then
    echo "ERROR: pdflatex not found or not executable"
    ls -la "$TEXLIVE_BIN_DIR/" | head -10
    exit 1
fi

# Set up PATH for package installation
export PATH="$TEXLIVE_BIN_DIR:$PATH"

echo "-----> Testing pdflatex installation"
"$TEXLIVE_BIN_DIR/pdflatex" --version | head -1 || {
    echo "ERROR: pdflatex test failed"
    exit 1
}

# Install additional packages needed for CV if tlmgr is available
if [ -x "$TEXLIVE_BIN_DIR/tlmgr" ]; then
    echo "-----> Installing additional packages for CV"
    PACKAGES="geometry fontawesome5 tcolorbox enumitem xcolor hyperref"
    
    for package in $PACKAGES; do
        echo "       Installing $package"
        "$TEXLIVE_BIN_DIR/tlmgr" install "$package" 2>/dev/null || echo "       Warning: Could not install $package"
    done
else
    echo "-----> tlmgr not available, using base TinyTeX packages"
fi

# Create environment setup script
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/texlive.sh" << EOF
export PATH="$TEXLIVE_BIN_DIR:\$PATH"
export TEXMFCACHE="/tmp/texmf-cache"
mkdir -p "\$TEXMFCACHE"
EOF

echo "-----> LaTeX installation complete"
echo "       TeX Live location: $TEXLIVE_DIR"
echo "       Binary location: $TEXLIVE_BIN_DIR"
echo "       pdflatex version:"
"$TEXLIVE_BIN_DIR/pdflatex" --version 2>/dev/null | head -1 || echo "       Could not get version"

# Create a test script for debugging
cat > "$BUILD_DIR/test-latex.sh" << EOF
#!/bin/bash
echo "Testing LaTeX installation:"
echo "PATH: \$PATH"
echo "pdflatex location: \$(which pdflatex)"
echo "pdflatex version: \$(pdflatex --version 2>&1 | head -1)"
echo "Available packages:"
ls "\$HOME/.texlive" 2>/dev/null || echo "No .texlive directory"
EOF
chmod +x "$BUILD_DIR/test-latex.sh"

echo "-----> Created test script at /app/test-latex.sh"
