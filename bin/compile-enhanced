#!/bin/bash
# Enhanced buildpack compile script for LaTeX CV generation with improved package management

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing TinyTeX for CV generation (Enhanced Version)"

# Set up directories
TEXLIVE_DIR="$BUILD_DIR/.texlive"
TEXLIVE_CACHE="$CACHE_DIR/texlive"

# Create directories
mkdir -p "$TEXLIVE_CACHE"
mkdir -p "$TEXLIVE_DIR"

# Use TinyTeX which is designed to be portable and lightweight
TINYTEX_URL="https://github.com/rstudio/tinytex-releases/releases/download/v2023.05/TinyTeX-1-v2023.05.tar.gz"
TINYTEX_ARCHIVE="$TEXLIVE_CACHE/tinytex.tar.gz"

echo "-----> Downloading TinyTeX (lightweight, portable TeX Live)"
if [ ! -f "$TINYTEX_ARCHIVE" ]; then
    curl -L -o "$TINYTEX_ARCHIVE" "$TINYTEX_URL" || {
        echo "ERROR: Failed to download TinyTeX"
        exit 1
    }
fi

echo "-----> Extracting TinyTeX to $TEXLIVE_DIR"
cd "$TEXLIVE_DIR"
tar -xzf "$TINYTEX_ARCHIVE" --strip-components=1 || {
    echo "ERROR: Failed to extract TinyTeX"
    exit 1
}

# Find the correct bin directory and verify pdflatex exists
TEXLIVE_BIN_DIR=""
echo "-----> Searching for TeX Live binaries..."

# More comprehensive search for binaries
for possible_dir in \
    "$TEXLIVE_DIR/.TinyTeX/bin/x86_64-linux" \
    "$TEXLIVE_DIR/bin/x86_64-linux" \
    "$TEXLIVE_DIR/bin/linux" \
    $(find "$TEXLIVE_DIR" -type d -name "x86_64-linux" 2>/dev/null) \
    $(find "$TEXLIVE_DIR" -type d -path "*/bin/*" 2>/dev/null); do
    
    if [ -d "$possible_dir" ] && [ -x "$possible_dir/pdflatex" ]; then
        TEXLIVE_BIN_DIR="$possible_dir"
        echo "       Found TeX Live binaries at: $TEXLIVE_BIN_DIR"
        break
    fi
done

if [ -z "$TEXLIVE_BIN_DIR" ]; then
    echo "ERROR: Could not find TeX Live binaries with pdflatex"
    echo "Directory structure:"
    find "$TEXLIVE_DIR" -type d -name "bin" 2>/dev/null || echo "No bin directories found"
    echo "Looking for pdflatex:"
    find "$TEXLIVE_DIR" -name "pdflatex" -type f 2>/dev/null || echo "No pdflatex found"
    echo "Available files in extracted directory:"
    ls -la "$TEXLIVE_DIR" 2>/dev/null || echo "Directory listing failed"
    exit 1
fi

# Test if pdflatex exists and works
if [ ! -x "$TEXLIVE_BIN_DIR/pdflatex" ]; then
    echo "ERROR: pdflatex not found or not executable"
    ls -la "$TEXLIVE_BIN_DIR/" | head -10
    exit 1
fi

# Set up PATH for package installation
export PATH="$TEXLIVE_BIN_DIR:$PATH"

echo "-----> Testing pdflatex installation"
"$TEXLIVE_BIN_DIR/pdflatex" --version | head -1 || {
    echo "ERROR: pdflatex test failed"
    exit 1
}

# Check if tlmgr is available and working
if [ -x "$TEXLIVE_BIN_DIR/tlmgr" ]; then
    echo "-----> Testing tlmgr functionality"
    if "$TEXLIVE_BIN_DIR/tlmgr" --version >/dev/null 2>&1; then
        echo "       tlmgr is working"
        
        echo "-----> Configuring tlmgr repository"
        # Try to set up the repository
        "$TEXLIVE_BIN_DIR/tlmgr" option repository ctan 2>/dev/null || \
        "$TEXLIVE_BIN_DIR/tlmgr" option repository https://mirror.ctan.org/systems/texlive/tlnet 2>/dev/null || {
            echo "       Warning: Could not set tlmgr repository, trying alternative"
            "$TEXLIVE_BIN_DIR/tlmgr" option repository https://ftp.math.utah.edu/pub/tex/historic/systems/texlive/2023/tlnet-final 2>/dev/null
        }
        
        echo "-----> Installing essential packages for CV generation"
        # Essential packages for CV generation
        PACKAGES=(
            "geometry"
            "fontawesome5" 
            "tcolorbox"
            "enumitem"
            "xcolor"
            "hyperref"
            "pgf"
            "etoolbox"
            "l3backend"
            "l3kernel"
            "l3packages"
            "amsfonts"
            "setspace"
        )
        
        SUCCESSFUL_INSTALLS=0
        TOTAL_PACKAGES=${#PACKAGES[@]}
        
        for package in "${PACKAGES[@]}"; do
            echo "       Installing $package..."
            if "$TEXLIVE_BIN_DIR/tlmgr" install "$package" 2>/dev/null; then
                echo "       ✓ Successfully installed $package"
                ((SUCCESSFUL_INSTALLS++))
            elif "$TEXLIVE_BIN_DIR/tlmgr" install --verify-repo=none "$package" 2>/dev/null; then
                echo "       ✓ Successfully installed $package (no verification)"
                ((SUCCESSFUL_INSTALLS++))
            else
                echo "       ✗ Failed to install $package"
            fi
        done
        
        echo "-----> Package installation summary: $SUCCESSFUL_INSTALLS/$TOTAL_PACKAGES packages installed successfully"
        
        if [ $SUCCESSFUL_INSTALLS -eq 0 ]; then
            echo "       Warning: No packages were installed successfully"
            echo "       CV compilation may fail due to missing packages"
        elif [ $SUCCESSFUL_INSTALLS -lt $TOTAL_PACKAGES ]; then
            echo "       Warning: Some packages failed to install"
            echo "       Some CV features may not work correctly"
        else
            echo "       All packages installed successfully!"
        fi
        
    else
        echo "       Warning: tlmgr is not working properly"
    fi
else
    echo "-----> tlmgr not available in this TinyTeX installation"
    echo "       Using base TinyTeX packages only - some CV features may not work"
fi

# Create environment setup script with comprehensive PATH and environment variables
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/texlive.sh" << EOF
# Set up TeX Live environment
export PATH="$TEXLIVE_BIN_DIR:\$PATH"

# Set up TeX directories
export TEXMFCACHE="/tmp/texmf-cache"
export TEXMFVAR="/tmp/texmf-var" 
export TEXMFHOME="\$HOME/.texlive/texmf"

# Create necessary directories
mkdir -p "\$TEXMFCACHE" "\$TEXMFVAR" "\$TEXMFHOME"

# Additional TeX environment variables
export TEXMF="{!!\$TEXMFHOME,!!\$TEXMFVAR,!!\$TEXMFCACHE}"
export TEXINPUTS=":\$TEXMFHOME/tex//::\$TEXMFVAR/tex//::\$TEXMFCACHE/tex//:"
EOF

echo "-----> LaTeX installation complete"
echo "       TeX Live location: $TEXLIVE_DIR"
echo "       Binary location: $TEXLIVE_BIN_DIR"
echo "       pdflatex version:"
"$TEXLIVE_BIN_DIR/pdflatex" --version 2>/dev/null | head -1 || echo "       Could not get version"

# Create comprehensive test script
cat > "$BUILD_DIR/test-latex.sh" << EOF
#!/bin/bash
echo "=== LaTeX Installation Test ==="
echo "PATH: \$PATH"
echo ""
echo "=== Binary Locations ==="
echo "pdflatex: \$(which pdflatex 2>/dev/null || echo 'NOT FOUND')"
echo "tlmgr: \$(which tlmgr 2>/dev/null || echo 'NOT FOUND')"
echo ""
echo "=== Versions ==="
echo "pdflatex version: \$(pdflatex --version 2>&1 | head -1)"
if command -v tlmgr >/dev/null 2>&1; then
    echo "tlmgr version: \$(tlmgr --version 2>&1 | head -1)"
else
    echo "tlmgr: NOT AVAILABLE"
fi
echo ""
echo "=== Package Test ==="
if command -v tlmgr >/dev/null 2>&1; then
    echo "Testing geometry package:"
    tlmgr info geometry 2>/dev/null | head -3 || echo "geometry package not found or tlmgr not working"
else
    echo "Cannot test packages - tlmgr not available"
fi
echo ""
echo "=== Directory Structure ==="
echo "TeX Live installation:"
ls -la "\$HOME/.texlive" 2>/dev/null || echo "No .texlive directory found"
echo ""
echo "=== Test Compilation ==="
# Create a minimal test document
cat > /tmp/test.tex << 'TESTEOF'
\\documentclass{article}
\\usepackage{geometry}
\\begin{document}
Test document
\\end{document}
TESTEOF

echo "Attempting to compile test document..."
if pdflatex -interaction=nonstopmode -output-directory=/tmp /tmp/test.tex >/dev/null 2>&1; then
    echo "✓ Test compilation successful!"
    ls -la /tmp/test.pdf 2>/dev/null && echo "PDF created successfully"
else
    echo "✗ Test compilation failed"
    echo "Error output:"
    pdflatex -interaction=nonstopmode -output-directory=/tmp /tmp/test.tex 2>&1 | tail -10
fi
EOF
chmod +x "$BUILD_DIR/test-latex.sh"

# Create package installer helper script
cat > "$BUILD_DIR/install-tex-package.sh" << EOF
#!/bin/bash
# Helper script to install LaTeX packages on-demand
PACKAGE=\$1
if [ -z "\$PACKAGE" ]; then
    echo "Usage: \$0 <package-name>"
    echo "Example: \$0 fontawesome5"
    exit 1
fi

echo "Installing LaTeX package: \$PACKAGE"
if command -v tlmgr >/dev/null 2>&1; then
    echo "Attempting installation..."
    if tlmgr install "\$PACKAGE"; then
        echo "✓ Successfully installed \$PACKAGE"
    elif tlmgr install --verify-repo=none "\$PACKAGE"; then
        echo "✓ Successfully installed \$PACKAGE (no verification)"
    else
        echo "✗ Failed to install \$PACKAGE"
        echo "You may need to check if the package name is correct or if the repository is accessible"
        exit 1
    fi
else
    echo "✗ tlmgr not available - cannot install \$PACKAGE"
    echo "This TinyTeX installation may not support package installation"
    exit 1
fi
EOF
chmod +x "$BUILD_DIR/install-tex-package.sh"

echo "-----> Created utility scripts:"
echo "       - /app/test-latex.sh (test installation)"
echo "       - /app/install-tex-package.sh (install packages on-demand)"
echo "-----> Installation complete!"
