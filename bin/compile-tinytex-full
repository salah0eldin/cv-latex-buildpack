#!/bin/bash
# Alternative buildpack compile script using TinyTeX with better package management

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing TinyTeX with full package management for CV generation"

# Set up directories
TEXLIVE_DIR="$BUILD_DIR/.texlive"
TEXLIVE_CACHE="$CACHE_DIR/texlive"

# Create directories
mkdir -p "$TEXLIVE_CACHE"
mkdir -p "$TEXLIVE_DIR"

# Use the install script approach for TinyTeX which includes tlmgr
TINYTEX_INSTALL_SCRIPT="$TEXLIVE_CACHE/install-tinytex.sh"

echo "-----> Downloading TinyTeX installation script"
if [ ! -f "$TINYTEX_INSTALL_SCRIPT" ]; then
    curl -L -o "$TINYTEX_INSTALL_SCRIPT" "https://yihui.org/tinytex/install-unx.sh" || {
        echo "ERROR: Failed to download TinyTeX installation script"
        exit 1
    }
fi

# Make the script executable and run it
chmod +x "$TINYTEX_INSTALL_SCRIPT"

echo "-----> Installing TinyTeX to $TEXLIVE_DIR"
# Set TINYTEX_DIR environment variable for the installer
export TINYTEX_DIR="$TEXLIVE_DIR"
"$TINYTEX_INSTALL_SCRIPT" || {
    echo "ERROR: TinyTeX installation failed"
    exit 1
}

# Find the correct bin directory
TEXLIVE_BIN_DIR=""
for possible_dir in \
    "$TEXLIVE_DIR/bin/x86_64-linux" \
    "$TEXLIVE_DIR/bin"/* \
    "$TEXLIVE_DIR/.TinyTeX/bin/x86_64-linux" \
    "$TEXLIVE_DIR/.TinyTeX/bin"/*; do
    
    if [ -d "$possible_dir" ] && [ -x "$possible_dir/pdflatex" ]; then
        TEXLIVE_BIN_DIR="$possible_dir"
        break
    fi
done

if [ -z "$TEXLIVE_BIN_DIR" ]; then
    echo "ERROR: Could not find TeX Live binaries with pdflatex"
    echo "Available directories:"
    find "$TEXLIVE_DIR" -type d -name "bin" 2>/dev/null || echo "No bin directories found"
    echo "Looking for pdflatex:"
    find "$TEXLIVE_DIR" -name "pdflatex" -type f 2>/dev/null || echo "No pdflatex found"
    exit 1
fi

echo "-----> Found TeX Live binaries at: $TEXLIVE_BIN_DIR"

# Test if pdflatex exists and works
if [ ! -x "$TEXLIVE_BIN_DIR/pdflatex" ]; then
    echo "ERROR: pdflatex not found or not executable"
    ls -la "$TEXLIVE_BIN_DIR/" | head -10
    exit 1
fi

# Set up PATH for package installation
export PATH="$TEXLIVE_BIN_DIR:$PATH"

echo "-----> Testing pdflatex installation"
"$TEXLIVE_BIN_DIR/pdflatex" --version | head -1 || {
    echo "ERROR: pdflatex test failed"
    exit 1
}

# Install additional packages needed for CV using tlmgr
if [ -x "$TEXLIVE_BIN_DIR/tlmgr" ]; then
    echo "-----> Installing additional packages for CV using tlmgr"
    
    # Essential packages for CV generation
    PACKAGES="geometry fontawesome5 tcolorbox enumitem xcolor hyperref pgf etoolbox l3backend l3kernel l3packages amsfonts psnfss setspace"
    
    for package in $PACKAGES; do
        echo "       Installing $package"
        if "$TEXLIVE_BIN_DIR/tlmgr" install "$package"; then
            echo "       ✓ Successfully installed $package"
        else
            echo "       ✗ Failed to install $package"
        fi
    done
else
    echo "-----> tlmgr not available - this may cause issues with CV compilation"
fi

# Create environment setup script
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/texlive.sh" << EOF
# Set up TeX Live environment
export PATH="$TEXLIVE_BIN_DIR:\$PATH"
export TEXMFCACHE="/tmp/texmf-cache"
export TEXMFVAR="/tmp/texmf-var"
mkdir -p "\$TEXMFCACHE" "\$TEXMFVAR"

# Ensure TeX Live can find its files
export TEXMFHOME="\$HOME/.texlive/texmf"
mkdir -p "\$TEXMFHOME"
EOF

echo "-----> LaTeX installation complete"
echo "       TeX Live location: $TEXLIVE_DIR"
echo "       Binary location: $TEXLIVE_BIN_DIR"
echo "       pdflatex version:"
"$TEXLIVE_BIN_DIR/pdflatex" --version 2>/dev/null | head -1 || echo "       Could not get version"

# Create a test script for debugging
cat > "$BUILD_DIR/test-latex.sh" << EOF
#!/bin/bash
echo "Testing LaTeX installation:"
echo "PATH: \$PATH"
echo "pdflatex location: \$(which pdflatex)"
echo "pdflatex version: \$(pdflatex --version 2>&1 | head -1)"
echo "tlmgr location: \$(which tlmgr)"
echo "Available packages test:"
if command -v tlmgr >/dev/null 2>&1; then
    echo "tlmgr is available"
    tlmgr info geometry 2>/dev/null | head -3 || echo "geometry package not found"
else
    echo "tlmgr not available"
fi
echo "TeX Live directories:"
ls "\$HOME/.texlive" 2>/dev/null || echo "No .texlive directory"
EOF
chmod +x "$BUILD_DIR/test-latex.sh"

echo "-----> Created test script at /app/test-latex.sh"
