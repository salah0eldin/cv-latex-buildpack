#!/bin/bash
# Buildpack compile script for minimal LaTeX setup

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Installing minimal LaTeX for CV generation"

# Set up directories
TEXLIVE_DIR="$BUILD_DIR/.texlive"
TEXLIVE_CACHE="$CACHE_DIR/texlive"

# Create cache directory if it doesn't exist
mkdir -p "$TEXLIVE_CACHE"
mkdir -p "$TEXLIVE_DIR"

# Install script location
INSTALL_TL="$TEXLIVE_CACHE/install-tl-unx.tar.gz"

# Download install-tl if not cached
if [ ! -f "$INSTALL_TL" ]; then
    echo "-----> Downloading TeX Live 2023 installer"
    curl -L -o "$INSTALL_TL" "https://ftp.math.utah.edu/pub/tex/historic/systems/texlive/2023/install-tl-unx.tar.gz" || {
        echo "ERROR: Failed to download TeX Live installer"
        exit 1
    }
fi

# Extract installer
echo "-----> Extracting TeX Live installer"
cd "$TEXLIVE_CACHE"
tar -xzf install-tl-unx.tar.gz || {
    echo "ERROR: Failed to extract TeX Live installer"
    exit 1
}

# Find the install-tl directory (it has a date in the name)
INSTALL_TL_DIR=$(find . -maxdepth 1 -name "install-tl-*" -type d | head -n1)

if [ -z "$INSTALL_TL_DIR" ]; then
    echo "ERROR: Could not find install-tl directory"
    exit 1
fi

echo "-----> Found installer directory: $INSTALL_TL_DIR"

# Create minimal installation profile
cat > "$TEXLIVE_CACHE/texlive.profile" << EOF
selected_scheme scheme-minimal
TEXDIR $TEXLIVE_DIR/2023
TEXMFCONFIG $TEXLIVE_DIR/texmf-config
TEXMFHOME $TEXLIVE_DIR/texmf
TEXMFLOCAL $TEXLIVE_DIR/texmf-local
TEXMFVAR $TEXLIVE_DIR/texmf-var
binary_x86_64-linux 1
collection-basic 1
collection-latex 1
instopt_adjustpath 0
instopt_adjustrepo 1
instopt_letter 0
instopt_portable 1
instopt_write18_restricted 1
tlpdbopt_autobackup 0
tlpdbopt_backupdir tlpkg/backups
tlpdbopt_create_formats 1
tlpdbopt_desktop_integration 0
tlpdbopt_file_assocs 0
tlpdbopt_generate_updmap 0
tlpdbopt_install_docfiles 0
tlpdbopt_install_srcfiles 0
tlpdbopt_post_code 1
tlpdbopt_sys_bin $TEXLIVE_DIR/bin
tlpdbopt_sys_info $TEXLIVE_DIR/share/info
tlpdbopt_sys_man $TEXLIVE_DIR/share/man
tlpdbopt_w32_multi_user 0
EOF

# Install TeX Live if not already installed
if [ ! -d "$TEXLIVE_DIR/2023" ]; then
    echo "-----> Installing minimal TeX Live"
    cd "$INSTALL_TL_DIR"
    perl ./install-tl -profile "$TEXLIVE_CACHE/texlive.profile" -repository https://ftp.math.utah.edu/pub/tex/historic/systems/texlive/2023/tlnet-final || {
        echo "ERROR: TeX Live installation failed"
        exit 1
    }
else
    echo "-----> TeX Live already installed"
fi

# Verify installation
if [ ! -f "$TEXLIVE_DIR/2023/bin/x86_64-linux/pdflatex" ]; then
    echo "ERROR: pdflatex not found after installation"
    ls -la "$TEXLIVE_DIR/2023/bin/" || echo "bin directory not found"
    exit 1
fi

# Set up PATH
export PATH="$TEXLIVE_DIR/2023/bin/x86_64-linux:$PATH"

echo "-----> Installing essential packages for CV"
PACKAGES=(
    "geometry"
    "fontawesome5"
    "tcolorbox"
    "enumitem" 
    "psnfss"
    "amsfonts"
    "hyperref"
    "setspace"
    "xcolor"
    "pgf"
    "etoolbox"
    "l3backend"
    "l3kernel"
    "l3packages"
)

for package in "${PACKAGES[@]}"; do
    echo "       Installing $package"
    "$TEXLIVE_DIR/2023/bin/x86_64-linux/tlmgr" install "$package" 2>/dev/null || echo "       Warning: Could not install $package"
done

# Create a script to set up the environment
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/texlive.sh" << 'EOF'
export PATH="/app/.texlive/2023/bin/x86_64-linux:$PATH"
export TEXMFCACHE="/tmp/texmf-cache"
mkdir -p "$TEXMFCACHE"
EOF

# Test installation
echo "-----> Testing pdflatex installation"
if "$TEXLIVE_DIR/2023/bin/x86_64-linux/pdflatex" --version > /dev/null 2>&1; then
    echo "       pdflatex is working!"
else
    echo "       WARNING: pdflatex test failed"
fi

echo "-----> LaTeX installation complete"
echo "       Installed packages: ${PACKAGES[*]}"
echo "       TeX Live location: /app/.texlive/2023"
echo "       pdflatex location: /app/.texlive/2023/bin/x86_64-linux/pdflatex"
